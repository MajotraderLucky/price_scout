# План диагностики API E-katalog.ru

## Цель

Исследовать E-katalog.ru на наличие скрытого API для получения данных о товарах и ценах.

---

## Этап 1: Анализ сетевых запросов (DevTools)

### 1.1 Подготовка

```
1. Открыть браузер (Chrome/Firefox) в режиме инкогнито
2. Открыть DevTools (F12)
3. Перейти на вкладку Network
4. Включить "Preserve log" (сохранение логов между переходами)
5. Фильтр: XHR/Fetch (исключить статику)
```

### 1.2 Тестовые сценарии

| Сценарий                   | URL / Действие                                  |
|----------------------------|-------------------------------------------------|
| Поиск товара               | e-katalog.ru -> поиск "Samsung Galaxy S24"      |
| Страница результатов       | Анализ загрузки списка товаров                  |
| Пагинация                  | Переключение страниц результатов                |
| Страница товара            | Клик на конкретный товар                        |
| Список цен                 | Загрузка таблицы "Где купить"                   |
| Фильтрация                 | Применение фильтров (цена, характеристики)      |
| Автокомплит                | Ввод текста в поисковую строку                  |

### 1.3 Что искать в запросах

**Признаки API:**

| Признак                    | Пример                                          |
|----------------------------|-------------------------------------------------|
| JSON ответ                 | Content-Type: application/json                  |
| REST endpoint              | /api/v1/search, /api/products                   |
| GraphQL                    | /graphql, query в теле запроса                  |
| XHR с данными              | Ответ содержит структурированные данные         |
| Параметры запроса          | ?q=samsung&page=1&sort=price                    |

**Что записывать:**

```
- URL запроса (полный, с параметрами)
- HTTP метод (GET/POST)
- Request Headers (особенно Cookie, Authorization, X-*)
- Request Body (для POST)
- Response Headers
- Response Body (первые 500 символов)
- Status Code
```

---

## Этап 2: Тестирование найденных endpoints

### 2.1 Инструменты

| Инструмент  | Использование                                       |
|-------------|-----------------------------------------------------|
| curl        | Быстрые тесты из командной строки                   |
| httpie      | Более читаемый вывод (http GET url)                 |
| Postman     | GUI для сложных запросов с авторизацией             |
| Python      | Автоматизация и парсинг ответов                     |

### 2.2 Шаблон curl для тестов

```bash
# Базовый запрос
curl -s "https://e-katalog.ru/api/endpoint" \
  -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
  -H "Accept: application/json" \
  -H "Accept-Language: ru-RU,ru;q=0.9" \
  | jq '.'

# С cookies (если требуется)
curl -s "https://e-katalog.ru/api/endpoint" \
  -H "User-Agent: Mozilla/5.0 ..." \
  -H "Cookie: session_id=xxx; ..." \
  | jq '.'

# POST запрос
curl -s -X POST "https://e-katalog.ru/api/endpoint" \
  -H "Content-Type: application/json" \
  -H "User-Agent: Mozilla/5.0 ..." \
  -d '{"query": "samsung"}' \
  | jq '.'
```

### 2.3 Проверочные вопросы

- [ ] Работает ли endpoint без cookies?
- [ ] Требуется ли специальный User-Agent?
- [ ] Есть ли rate limiting? (повторить запрос 10 раз)
- [ ] Какой формат ответа? (JSON/HTML/Protobuf)
- [ ] Какие параметры обязательны?
- [ ] Как выглядит пагинация?

---

## Этап 3: Анализ структуры данных

### 3.1 Ожидаемые данные в ответе поиска

```json
{
  "products": [
    {
      "id": "12345",
      "name": "Samsung Galaxy S24",
      "url": "/samsung-galaxy-s24.htm",
      "image": "https://...",
      "price_min": 59990,
      "price_max": 79990,
      "shops_count": 42,
      "rating": 4.8
    }
  ],
  "total": 150,
  "page": 1,
  "per_page": 20
}
```

### 3.2 Ожидаемые данные в ответе цен

```json
{
  "product_id": "12345",
  "prices": [
    {
      "shop_name": "DNS",
      "price": 59990,
      "url": "https://dns-shop.ru/...",
      "in_stock": true,
      "delivery": "1-2 дня"
    }
  ]
}
```

---

## Этап 4: Документирование результатов

### 4.1 Шаблон документации endpoint

```markdown
## Endpoint: /api/search

**URL:** `https://e-katalog.ru/api/search`
**Метод:** GET

### Параметры запроса

| Параметр | Тип    | Обязательный | Описание            |
|----------|--------|--------------|---------------------|
| q        | string | да           | Поисковый запрос    |
| page     | int    | нет          | Номер страницы      |
| sort     | string | нет          | Сортировка          |

### Заголовки

| Header       | Значение                  | Обязательный |
|--------------|---------------------------|--------------|
| User-Agent   | Mozilla/5.0 ...           | да           |
| Cookie       | session_id=xxx            | нет          |

### Пример запроса

curl -s "https://e-katalog.ru/api/search?q=samsung" -H "User-Agent: ..."

### Пример ответа

{...}

### Rate Limits

- Лимит: X запросов в минуту
- При превышении: HTTP 429 / CAPTCHA / блокировка
```

---

## Этап 5: Fallback - HTML парсинг

Если скрытый API не найден или недоступен:

### 5.1 Анализ HTML структуры

```
1. Открыть страницу результатов поиска
2. Inspect Element на карточке товара
3. Записать CSS-селекторы для:
   - Контейнер карточки
   - Название товара
   - Цена (мин/макс)
   - Ссылка на товар
   - Изображение
```

### 5.2 Инструменты для HTML анализа

```bash
# Скачать HTML страницы
curl -s "https://e-katalog.ru/ek-list.php?search_=samsung" \
  -H "User-Agent: Mozilla/5.0 ..." \
  -o search_results.html

# Анализ через Python
python3 -c "
from bs4 import BeautifulSoup
with open('search_results.html') as f:
    soup = BeautifulSoup(f.read(), 'html.parser')
    # Поиск элементов
    cards = soup.select('.model-short-block')
    print(f'Found {len(cards)} product cards')
"
```

---

## Чек-лист выполнения

### Сетевой анализ

- [ ] Проанализированы XHR запросы при поиске
- [ ] Проанализированы запросы при загрузке страницы товара
- [ ] Проанализированы запросы при загрузке цен
- [ ] Записаны все найденные endpoints
- [ ] Определены обязательные заголовки

### Тестирование API

- [ ] Каждый endpoint протестирован через curl
- [ ] Проверена работа без cookies
- [ ] Проверен rate limiting
- [ ] Задокументирована структура ответов

### Документация

- [ ] Создан файл API_ENDPOINTS.md с описанием всех endpoints
- [ ] Примеры запросов и ответов сохранены
- [ ] Определена стратегия (API vs HTML парсинг)

---

## Результат диагностики

После выполнения плана заполнить:

| Вопрос                          | Ответ            |
|---------------------------------|------------------|
| Найден скрытый API?             | [ ] да / [ ] нет |
| Формат данных                   |                  |
| Требуется авторизация?          | [ ] да / [ ] нет |
| Требуются cookies?              | [ ] да / [ ] нет |
| Rate limiting                   |                  |
| Рекомендуемая стратегия         |                  |
